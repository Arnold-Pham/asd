---
- name: Déployer l'infrastructure sur Sun
  remote_user: ubuntu
  hosts: sun
  become: true

  tasks:
    - name: Copier le dossier Terraform Cloud vers Sun
      copy:
        src: ../../Cloud/
        dest: /home/ubuntu/Cloud
        mode: '0755'

    - name: Copier le script d'installation sur Sun
      copy:
        src: ./script.sh
        dest: /home/ubuntu/script.sh
        mode: '0755'

    - name: Exécuter le script et capturer les logs
      command: bash /home/ubuntu/script.sh > /home/ubuntu/script.log
      register: script_output
      ignore_errors: true

    - name: Récupérer les logs sur l'hôte local
      fetch:
        src: /home/ubuntu/script.log
        dest: ./script.log
        flat: yes